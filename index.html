<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ak_prod_process</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 p-4 text-gray-800">
    <!-- Sticky Header -->
    <header class="sticky top-0 z-50 ">
        <div class="max-w-7xl mx-auto">
            <div class="flex border-b border-gray-300 bg-white">
                <button data-tab="tab1"
                    class="tab-btn px-4 py-3 text-indigo-600 border-b-2 border-indigo-600 font-semibold">Get page source</button>
                <button data-tab="tab2"
                    class="tab-btn px-4 py-3 text-gray-600 hover:text-indigo-600">Bulk Image Watermark</button>
                <button data-tab="tab3"
                    class="tab-btn px-4 py-3 text-gray-600 hover:text-indigo-600">HTML Parser</button>
                <div id="statusMessage" class="tab-btn px-4 py-3 text-green-600 text-sm"></div>
            </div>
        </div>
    </header>

    <!-- Tabs -->
    <div class="max-w-7xl mx-auto">
        <!-- Tab 1 -->
        <div id="tab1" class="tab-content bg-white shadow rounded-lg p-4">
            <h3 class="text-lg font-semibold mb-3">Get page source</h3>
            <div class="mb-3">
                <form id="fetchPageSourceForm" class="flex flex-col gap-2 sm:flex-row items-center">
                    <input type="text" id="url" placeholder="Enter webpage link" required autofocus
                        class="flex-1 rounded border-gray-300 focus:border-indigo-500 focus:ring focus:ring-indigo-200 transition p-2">
                    <span id="resultsContainerPageSrc"></span>
                    <button type="submit"
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition">Get Data</button>
                </form>
            </div>

            <textarea id="imageLinks" placeholder="Product img links" rows="5"
                class="w-full border border-gray-300 rounded p-2 focus:border-indigo-500 focus:ring focus:ring-indigo-200 mb-3"></textarea>
            <textarea id="sourceCode" placeholder="Page source" rows="5"
                class="w-full border border-gray-300 rounded p-2 mb-3"></textarea>
            <button id="btnCopyPageSource"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded transition">Copy Page Source</button>
        </div>

        <!-- Tab 2 -->
        <div id="tab2" class="tab-content bg-white shadow rounded-lg p-4 hidden">
            <h3 class="text-lg font-semibold mb-3">Bulk Image Watermark</h3>

            <form id="watermarkForm" class="flex flex-col gap-2">
                <textarea name="image_urls" placeholder="Product img links" rows="5"
                    class="w-full border border-gray-300 rounded p-2 focus:border-indigo-500 focus:ring focus:ring-indigo-200"></textarea>
                <div>
                    <button type="submit"
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition">Process Images</button>
                </div>
            </form>

            <div id="resultsContainer" class="mt-2"></div>
        </div>

        <!-- Tab 3 -->
        <div id="tab3" class="tab-content bg-white shadow rounded-lg p-4 hidden">
            <h3 class="text-lg font-semibold mb-3">HTML Parser</h3>
            <div class="space-y-4">
                <div class="bg-gray-50 p-4 rounded shadow-sm space-y-2">
                    <div class="flex flex-col gap-2">
                        <textarea id="sourceHTML" placeholder="Paste your HTML here (Page source)"
                            class="flex-1 border border-gray-300 rounded p-2 focus:border-indigo-500 focus:ring focus:ring-indigo-200"></textarea>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button id="pasteClipboardBtn"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded transition">Paste from Clipboard</button>
                            <button id="processBtn"
                                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition">Parse</button>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded shadow-sm space-y-2">
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="productSKU" placeholder="SKU" 
                            class="border border-gray-300 rounded p-2">
                        <input type="text" id="productTitle" placeholder="Title" 
                            class="flex-1 border border-gray-300 rounded p-2">
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <textarea id="outputHTML" placeholder="Body (processed HTML)" rows="10"
                            class="flex-1 border border-gray-300 rounded p-2 focus:border-indigo-500 focus:ring focus:ring-indigo-200"></textarea>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <textarea id="productShortDesc" placeholder="Short description"
                            class="flex-1 border border-gray-300 rounded p-2 focus:border-indigo-500 focus:ring focus:ring-indigo-200"></textarea>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-2">
                        <div>
                            <button id="btn_productTitle"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded transition">Copy Title</button>
                        </div>
                        <div>
                            <button id="copyOutputBtn"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded transition">Copy Body</button>
                        </div>
                        <div>
                            <button id="btn_productShortDesc"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded transition">Copy Short Description</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6">
                <h3 class="text-lg font-semibold mb-2">Preview:</h3>
                <div id="templatePreview" class="border border-gray-300 rounded p-4 bg-white"></div>
            </div>
        </div>
    </div>

    <script>
        // === Tab switching ===
        document.querySelectorAll(".tab-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                document.querySelectorAll(".tab-btn").forEach(b => {
                    b.classList.remove("text-indigo-600", "border-indigo-600", "font-semibold");
                    b.classList.add("text-gray-600", "border-b-2", "border-transparent");
                });
                btn.classList.remove("text-gray-600");
                btn.classList.add("text-indigo-600", "border-indigo-600", "font-semibold");

                document.querySelectorAll(".tab-content").forEach(tab => tab.classList.add("hidden"));
                document.getElementById(btn.dataset.tab).classList.remove("hidden");
            });
        });

        // === Original functionality ===
        const processBtn = document.getElementById('processBtn');
        const sourceHTML = document.getElementById('sourceHTML');
        const outputHTML = document.getElementById('outputHTML');
        const templatePreview = document.getElementById('templatePreview');
        const pasteClipboardBtn = document.getElementById('pasteClipboardBtn');
        const copyOutputBtn = document.getElementById('copyOutputBtn');
        const htmlTemplate =
            `<div id="prod_desc" class="kcard">
<div class="kcard-b">
PROD_DESC
</div>
</div>

<div id="prod_specs" class="kcard">
<div class="kcard-h">Product Specifications</div>
<div class="kcard-b">
SPECS_TABLE
</div>
</div>

<div id="prod_fitments" class="kcard">
<div class="kcard-h">Fitments</div>
<div class="kcard-b">
<div id="Models" class="mb-5">
FITMENTS_TABLE
</div>
</div>
</div>

<div id="prod_xdetails" class="kcard hidden">
<div class="kcard-h">Extra Details</div>
<div class="kcard-b">
<div id="Models" class="mb-5">
EXTRA_DETAILS
</div>
</div>
</div>

<div id="prod_acc" class="kcard">
<div class="kcard-h">Accessories</div>
<div class="kcard-b">[products name="accessories" skus="123"]</div>
</div>`;
        const statusMessage = document.getElementById("statusMessage");

        function showMessage(msg) {
            statusMessage.textContent = `✅ ${msg}`;
            statusMessage.style.opacity = 1;
            setTimeout(() => {
                statusMessage.style.opacity = 0;
                statusMessage.textContent = "";
            }, 3000);
        }

        function copyInputValueById(elementId) {
            const el = document.getElementById(elementId);
            if (!el) return;
            const value = el.value ?? '';
            navigator.clipboard.writeText(value)
                .then(() => showMessage(`Copied value from #${elementId} to clipboard.`))
                .catch(err => console.error('Failed to copy:', err));
        }

        processBtn.addEventListener('click', () => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(sourceHTML.value, 'text/html');
            const skuMatch = sourceHTML.value.match(/\bMK\d{5}\b/);
            const prodSku = skuMatch ? (skuMatch[0]).replace('MK', 'AK') : "";
            const prodTitle = doc.querySelector("article.info-wrap2 h1")?.innerHTML || "";
            const alertDiv = doc.querySelector('.alert');
            const prodDesc = alertDiv ? alertDiv.innerHTML.trim() : '';
            const prodShortDesc = `${prodDesc} | Product Number: ${prodSku}`;

            let specsHTML = '';
            const specsContainer = doc.querySelector('.inside-product-specs2');
            if (specsContainer) {
                const table = specsContainer.querySelector('.specsTable');
                if (table) specsHTML = table.outerHTML.trim();
            }

            const fitmentsTable = doc.querySelector('.fitmentsTable');
            const fitmentsHTML = fitmentsTable ? fitmentsTable.outerHTML.trim() : '';

            let filledTemplate = htmlTemplate
                .replace('PROD_DESC', `<strong>${prodDesc} | Product Number: ${prodSku}</strong>`)
                .replace('SPECS_TABLE', specsHTML)
                .replace('FITMENTS_TABLE', fitmentsHTML);

            document.getElementById("productSKU").value = prodSku;
            document.getElementById("productShortDesc").value = prodShortDesc;
            document.getElementById("productTitle").value = prodTitle;
            outputHTML.value = filledTemplate;
            templatePreview.innerHTML = filledTemplate;

            showMessage("Done parsing the HTML!");
        });

        pasteClipboardBtn.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                sourceHTML.value = text;
                showMessage("Pasted clipboard content into source!");
            } catch (err) {
                console.error("Failed to read clipboard:", err);
            }
        });

        copyOutputBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(outputHTML.value).then(() => {
                showMessage("Output HTML copied to clipboard!");
            });
        });

        document.getElementById("fetchPageSourceForm").addEventListener("submit", function (e) {
            e.preventDefault();
            let url = document.getElementById("url").value.trim();
            if (!url) {
                alert("Please enter a valid URL.");
                return;
            }

            document.getElementById('resultsContainerPageSrc').innerHTML = "⏳ Processing...";
            fetch("get_page_source.php", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: "url=" + encodeURIComponent(url)
            })
                .then(res => res.json())
                .then(data => {
                    document.getElementById("sourceCode").value = data.source || "Failed to fetch source.";
                    document.getElementById("imageLinks").value = (data.images && data.images.length)
                        ? data.images.join("\n")
                        : "No images found.";
                })
                .catch(err => {
                    console.error(err);
                    alert("Error fetching data.");
                }).finally(() => {
                    document.getElementById('resultsContainerPageSrc').innerHTML = "";
                });
        });

        document.getElementById('watermarkForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const resultsDiv = document.getElementById('resultsContainer');
            resultsDiv.innerHTML = "⏳ Processing...";
            try {
                const response = await fetch('process_imgs.php', { method: 'POST', body: formData });
                const data = await response.json();
                if (data.error) {
                    resultsDiv.innerHTML = `<p class="text-red-600">${data.error}</p>`;
                    return;
                }
                let html = `<table class="border border-gray-300 mt-4 w-full">
                    <tr class="bg-gray-100"><th class="p-2 border">Image URL</th><th class="p-2 border">Status</th><th class="p-2 border">Original</th><th class="p-2 border">Watermarked</th></tr>`;
                data.results.forEach(res => {
                    html += `<tr>
                        <td class="p-2 border">${res.url}</td>
                        <td class="p-2 border">${res.status}</td>
                        <td class="p-2 border">${res.original ? `<a href="output/${encodeURIComponent(res.original)}" target="_blank" class="text-indigo-600 underline">View</a>` : ''}</td>
                        <td class="p-2 border">${res.watermarked ? `<a href="output/${encodeURIComponent(res.watermarked)}" target="_blank" class="text-indigo-600 underline">View</a>` : ''}</td>
                    </tr>`;
                });
                html += '</table>';
                resultsDiv.innerHTML = html;
            } catch (err) {
                resultsDiv.innerHTML = `<p class="text-red-600">❌ Error: ${err.message}</p>`;
            }
        });

        document.getElementById('btnCopyPageSource').addEventListener('click', () => {
            copyInputValueById('sourceCode');
        });
        document.getElementById('btn_productTitle').addEventListener('click', () => {
            copyInputValueById('productTitle');
        });
        document.getElementById('btn_productShortDesc').addEventListener('click', () => {
            copyInputValueById('productShortDesc');
        });
    </script>
</body>

</html>
